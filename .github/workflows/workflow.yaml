name: abtech.org

on:
  push:
    branches:
      # - 'master'
      - 'dev'
      - '!gh-pages'
    paths-ignore:
      - 'etc/**'
  pull_request:
    branches:
      # - 'master'
      - 'dev'
  # tags:
    # - '*'

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ruby:3.0.1-buster
    steps:
      - name: Checkout latest
        uses: actions/checkout@v2
      - name: Install Node
        run: >
          NODE_VERSION=node_14.x && 
          NODE_DISTRO=buster && 
          curl -fsSL https://deb.nodesource.com/gpgkey/nodesource.gpg.key | apt-key add -  && 
          echo "deb https://deb.nodesource.com/$NODE_VERSION $NODE_DISTRO main" | tee /etc/apt/sources.list.d/nodesource.list && 
          echo "deb-src https://deb.nodesource.com/$NODE_VERSION $NODE_DISTRO main" | tee -a /etc/apt/sources.list.d/nodesource.list && 
          apt-get update -y && apt-get install -y nodejs=14.17.0-1nodesource1
      - name: Cache Ruby dependencies
        uses: actions/cache@v2
        env:
          cache-name: cache-ruby-gems
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/Gemfile.lock', '**/Gemfile', '**/Dockerfile') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-
      - name: Install Ruby dependencies
        run: bundle config path vendor/bundle && bundle install --jobs 4 --retry 3
      - name: Install NodejS dependencies
        run: npm install
      - name: Build Jekyll
        run: JEKYLL_ENV="production" bundle exec jekyll build
      - name: 'Archive files'
        run: tar -cvf _site.tar -C _site .
      - name: Upload Artifact
        uses: actions/upload-artifact@v2
        with:
          name: "_site"
          path: _site.tar
  publish:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout gh-pages branch of repo
        uses: actions/checkout@v2
        with:
          ref: "gh-pages"
      - name: Clear branch of previous build
        run: |
          git rm -rf . --ignore-unmatch
          git clean -fxd
      - name: Download built artifact
        uses: actions/download-artifact@v2
        with:
          name: "_site"
      - name: 'Unarchive files & remove archive'
        run: tar -xvf _site.tar && rm _site.tar
      - name: Commit and push new artifact
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add . --all
          git commit -m "abtech.org publish $GITHUB_SHA"
          git push
